from unittest import TestCase
from kraken_book import KrakenBookWss
import asyncio


EXAMPLE_SNAPSHOT = """
[
0,
{
"as": [
    [ "0.05005", "0.00000500", "1582905487.684110" ],
    [ "0.05010", "0.00000500", "1582905486.187983" ],
    [ "0.05015", "0.00000500", "1582905484.480241" ],
    [ "0.05020", "0.00000500", "1582905486.645658" ],
    [ "0.05025", "0.00000500", "1582905486.859009" ],
    [ "0.05030", "0.00000500", "1582905488.601486" ],
    [ "0.05035", "0.00000500", "1582905488.357312" ],
    [ "0.05040", "0.00000500", "1582905488.785484" ],
    [ "0.05045", "0.00000500", "1582905485.302661" ],
    [ "0.05050", "0.00000500", "1582905486.157467" ] ],
"bs": [
    [ "0.05000", "0.00000500", "1582905487.439814" ],
    [ "0.04995", "0.00000500", "1582905485.119396" ],
    [ "0.04990", "0.00000500", "1582905486.432052" ],
    [ "0.04980", "0.00000500", "1582905480.609351" ],
    [ "0.04975", "0.00000500", "1582905476.793880" ],
    [ "0.04970", "0.00000500", "1582905486.767461" ],
    [ "0.04965", "0.00000500", "1582905481.767528" ],
    [ "0.04960", "0.00000500", "1582905487.378907" ],
    [ "0.04955", "0.00000500", "1582905483.626664" ],
    [ "0.04950", "0.00000500", "1582905488.509872" ] ]
},
"example",
"EXAMPL"
]
"""


class checksum_test(TestCase):

    def setUp(self):
        self.book_wss = KrakenBookWss()
        self.loop = asyncio.new_event_loop()
        asyncio.set_event_loop(None)

    def test_payload(self):
        self.loop.run_until_complete(self.book_wss.on_message(None, '{"connectionID":12682039517364857791,"event":"systemStatus","status":"online","version":"1.4.2"}'))
   
        self.loop.run_until_complete(self.book_wss.on_message(None, '{"event":"pong","reqid":2}'))
        self.loop.run_until_complete(self.book_wss.on_message(None, '[0, {"as": [["19080.10000", "2.50088673", "1606327572.772979"], ["19080.20000", "0.02000000", "1606327568.293020"], ["19086.30000", "0.43221858", "1606327570.200149"], ["19086.40000", "6.09621455", "1606327579.488910"], ["19086.50000", "0.13300000", "1606327579.916968"], ["19087.60000", "0.45006648", "1606327557.346064"], ["19088.00000", "7.19077009", "1606327577.635023"], ["19088.30000", "2.09616907", "1606327573.223196"], ["19089.30000", "0.15101769", "1606327578.635694"], ["19089.40000", "0.27500000", "1606327576.941447"]], "bs": [["19080.00000", "5.60325729", "1606327576.572153"], ["19079.90000", "0.02000000", "1606327573.372936"], ["19079.80000", "0.30714802", "1606327572.174573"], ["19079.70000", "1.31018743", "1606327571.762458"], ["19079.60000", "2.09610575", "1606327571.761676"], ["19079.50000", "0.84803000", "1606327574.849814"], ["19078.80000", "0.16588000", "1606327571.725756"], ["19077.90000", "2.61900000", "1606327579.222629"], ["19077.80000", "0.89789000", "1606327573.598259"], ["19077.50000", "2.09637417", "1606327571.763379"]]}, "book-100", "XBT/USD"]'))
        self.assertTrue(self.book_wss.is_running)
        self.loop.run_until_complete(self.book_wss.on_message(None, '[0, {"a": [["19086.50000", "1.44304296", "1606327580.831559"]], "c": "184871026"}, "book-100", "XBT/USD"]'))
        self.assertTrue(self.book_wss.is_running)        


        
    def test_kraken_example_string(self):

     self.loop.run_until_complete(self.book_wss.on_message(None, EXAMPLE_SNAPSHOT))

     solution = '50055005010500501550050205005025500503050050355005040500504550050505005000500499550049905004980500497550049705004965500496050049555004950500'

     block = self.book_wss.checksum_block()

     self.assertEquals(solution, block)
        

    def test_kraken_example(self):

     self.loop.run_until_complete(self.book_wss.on_message(None, EXAMPLE_SNAPSHOT))

     book_crc32 = self.book_wss.book_checksum()

     self.assertEquals(974947235, book_crc32)
